name: Cleanup GitHub Pages Previews

on:
  pull_request:
    types: [closed]
  schedule:
    # Run weekly on Saturday at midnight UTC to clean up stale previews
    - cron: '0 0 * * 6'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write
  pull-requests: read

jobs:
  cleanup:
    name: Remove preview deployment
    runs-on: ubuntu-latest

    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages

      - name: Checkout main repository (for PR check)
        uses: actions/checkout@v4
        with:
          path: main-repo

      - name: Remove closed PR preview folder
        if: github.event_name == 'pull_request'
        run: |
          set -e
          PR_NUMBER="${{ github.event.pull_request.number }}"
          if [ -d "$PR_NUMBER" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git rm -rf "$PR_NUMBER"
            if ! git diff-index --quiet HEAD --; then
              git commit -m "Remove preview for closed PR #$PR_NUMBER"
              git push origin gh-pages
              echo "‚úÖ Removed preview folder: $PR_NUMBER"
            else
              echo "‚ÑπÔ∏è No changes to commit for PR #$PR_NUMBER"
            fi
          else
            echo "‚ÑπÔ∏è No preview folder found for PR #$PR_NUMBER"
          fi

      - name: Clean up stale previews (scheduled/manual)
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          cd main-repo

          echo "üîç Checking for stale preview deployments..."

          # Get list of open PRs with error handling
          OPEN_PRS=$(gh pr list --state open --json number --jq '.[].number' | sort -n) || {
            echo "‚ùå Failed to fetch open PRs"
            exit 1
          }
          echo "Open PRs: $OPEN_PRS"

          cd ..

          # Get list of deployed preview folders (only numeric folders)
          DEPLOYED_FOLDERS=$(find . -maxdepth 1 -type d -name '[0-9]*' | sed 's|./||' | sort -n)
          echo "Deployed folders: $DEPLOYED_FOLDERS"

          # Configure git once before the loop
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Track if we made any changes
          CHANGES_MADE=false

          # Check each deployed folder
          for folder in $DEPLOYED_FOLDERS; do
            # Check if this PR number exists in open PRs
            if ! echo "$OPEN_PRS" | grep -q "^${folder}$"; then
              echo "üóëÔ∏è  Removing stale preview: $folder (PR is closed or merged)"
              git rm -rf "$folder"
              CHANGES_MADE=true
            else
              echo "‚úÖ Keeping active preview: $folder"
            fi
          done

          # Commit and push if we made changes
          if [ "$CHANGES_MADE" = true ]; then
            if ! git diff-index --quiet HEAD --; then
              git commit -m "Clean up stale PR previews (scheduled cleanup)"
              git push origin gh-pages
              echo "‚ú® Cleanup completed successfully"
            else
              echo "‚ÑπÔ∏è No actual changes to commit"
            fi
          else
            echo "‚ú® No stale previews found - nothing to clean up"
          fi
