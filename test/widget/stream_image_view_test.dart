import 'dart:typed_data';

import 'package:fluffychat/widgets/stream_image_view.dart';
import 'package:flutter/material.dart';
import 'package:flutter_test/flutter_test.dart';
import 'package:matrix/matrix.dart';

void main() {
  const List<int> kBlueLandscapePng = <int>[
    137,
    80,
    78,
    71,
    13,
    10,
    26,
    10,
    0,
    0,
    0,
    13,
    73,
    72,
    68,
    82,
    0,
    0,
    0,
    100,
    0,
    0,
    0,
    50,
    8,
    6,
    0,
    0,
    0,
    170,
    53,
    126,
    190,
    0,
    0,
    0,
    4,
    115,
    66,
    73,
    84,
    8,
    8,
    8,
    8,
    124,
    8,
    100,
    136,
    0,
    0,
    0,
    143,
    73,
    68,
    65,
    84,
    120,
    156,
    237,
    209,
    65,
    13,
    0,
    32,
    16,
    192,
    176,
    3,
    255,
    158,
    225,
    141,
    2,
    246,
    104,
    21,
    44,
    217,
    154,
    57,
    103,
    200,
    216,
    191,
    3,
    120,
    25,
    18,
    99,
    72,
    140,
    33,
    49,
    134,
    196,
    24,
    18,
    99,
    72,
    140,
    33,
    49,
    134,
    196,
    24,
    18,
    99,
    72,
    140,
    33,
    49,
    134,
    196,
    24,
    18,
    99,
    72,
    140,
    33,
    49,
    134,
    196,
    24,
    18,
    99,
    72,
    140,
    33,
    49,
    134,
    196,
    24,
    18,
    99,
    72,
    140,
    33,
    49,
    134,
    196,
    24,
    18,
    99,
    72,
    140,
    33,
    49,
    134,
    196,
    24,
    18,
    99,
    72,
    140,
    33,
    49,
    134,
    196,
    24,
    18,
    99,
    72,
    140,
    33,
    49,
    134,
    196,
    24,
    18,
    99,
    72,
    140,
    33,
    49,
    134,
    196,
    24,
    18,
    99,
    72,
    140,
    33,
    49,
    134,
    196,
    24,
    18,
    99,
    72,
    140,
    33,
    49,
    134,
    196,
    92,
    164,
    190,
    2,
    98,
    53,
    3,
    99,
    174,
    0,
    0,
    0,
    0,
    73,
    69,
    78,
    68,
    174,
    66,
    96,
    130,
  ];

  group(
    'stream image view tests',
    () {
      testWidgets(
        'GIVE a MatrixFile with image stream data'
        'WHEN StreamImageViewer is rendered'
        'THEN the image is loaded and displayed'
        'AND the onImageLoaded callback is called with the loaded image',
        (WidgetTester tester) async {
          final mockMatrixFile = MatrixFile(
            name: 'test1.png',
            bytes: Uint8List.fromList(kBlueLandscapePng),
            mimeType: 'image/png',
          );

          MatrixFile? loadedFile;

          await tester.pumpWidget(
            MaterialApp(
              home: StreamImageViewer(
                matrixFile: mockMatrixFile,
                onImageLoaded: (file) {
                  loadedFile = file;
                },
              ),
            ),
          );

          await tester.pumpAndSettle();

          expect(loadedFile, isNotNull);

          expect(mockMatrixFile.size == loadedFile?.size, true);

          expect(loadedFile?.name.equals(mockMatrixFile.name), true);

          expect(loadedFile?.bytes != null, true);

          expect(loadedFile?.bytes.length, kBlueLandscapePng.length);
        },
      );
    },
  );
}
